name: Race Scraper + AI Prediction + Discord

on:
  workflow_dispatch:   # 手動実行

jobs:
  run:
    runs-on: ubuntu-latest

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

    steps:

    # ----------------------------------------
    # ① ソース取得
    # ----------------------------------------
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt


    # ----------------------------------------
    # ② 実行日取得（JST）
    # ----------------------------------------
    - name: Get Target Date (JST)
      run: |
        export TZ="Asia/Tokyo"
        TODAY=$(date +'%Y%m%d')
        echo "TODAY=$TODAY" >> $GITHUB_ENV
        echo "TARGET DATE = $TODAY"


    # ----------------------------------------
    # ③ スクレイピング
    # race_data_YYYYMMDD/ 以下にCSV生成
    # ----------------------------------------
    - name: Scrape Race Data
      run: |
        python race_info_collect.py ${TODAY}


    # ----------------------------------------
    # ④ AI用CSV整形（aiready.csv生成）
    # ----------------------------------------
    - name: Prepare AI Input
      run: |
        python prepare_ai_input.py ${TODAY}


    # ----------------------------------------
    # ⑤ AI解析（レースごとにループ）
    # aiready.csv → json ＋ prompt.txt
    # ----------------------------------------
    - name: Run AI Predictions (time order)
      run: |
        for csv in $(ls race_data_${TODAY}/*_aiready.csv | sort); do
        echo "AI解析（時刻順）: $csv"
          python predict_race_ai.py "$csv" gpt-4.0-mini
        done



    # ----------------------------------------
    # ⑥ Discord通知（レースごと）
    # json + aiready.csv をペアで送信
    # ----------------------------------------
    - name: Send Discord Notifications (time order)
      if: success()
      run: |
        BASE_DIR="race_data_${TODAY}"
        echo "通知対象レース:"
        ls "${BASE_DIR}"/*_aiready.csv | sort
        for csv in $(ls "${BASE_DIR}"/*_aiready.csv | sort); do
          json="${csv%.csv}.json"
          if [ -f "$json" ]; then
            echo "通知: $json"
            python notify_discord.py "$json" "$csv"
          else
            echo "⚠ json が存在しないためスキップ: $json"
          fi
        done
