name: Race Scraper + AI Prediction

on:
  workflow_dispatch:   # 手動実行のみ

jobs:
  scrape:
    runs-on: ubuntu-latest

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

    steps:

    # ----------------------------------------
    # ① ソース取得
    # ----------------------------------------
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: pip install -r requirements.txt


    # ----------------------------------------
    # ② 実行日を取得（手動実行日のYYYYMMDD）
    # ----------------------------------------
    - name: Get Target Date
      id: runtime
      run: |
        export TZ="Asia/Tokyo"
        TODAY=$(date +'%Y%m%d')
        echo "TODAY=$TODAY" >> $GITHUB_ENV
        echo "実行日 = $TODAY"


    # ----------------------------------------
    # ③ スクレイピング（全レースのCSV生成）
    # ----------------------------------------
    - name: Scrape Race Data
      run: |
        python race_info_collect.py ${TODAY}


    # ----------------------------------------
    # ④ AI解析用に整形
    # 各レースごとに race_common.csv と race_detail_ai_ready.csv を生成
    # ----------------------------------------
    - name: Prepare AI Input
      run: |
        python prepare_ai_input.py --input_dir race_data_${TODAY}


    # ----------------------------------------
    # ⑤ AI解析（GPT）
    # 各レースフォルダをループして勝率推論
    # ----------------------------------------
    - name: Run AI Predictions
      run: |
        python ai_predict.py --base_dir race_data_${TODAY}


    # ----------------------------------------
    # ⑥ Discord通知（任意）
    # prediction.csv をまとめて送信
    # ----------------------------------------
    - name: Send Discord Notification
      if: success()
      run: |
        python send_discord.py --base_dir race_data_${TODAY}        
