name: Race Scraper + AI Prediction + Discord

on:
  workflow_dispatch:   # 手動実行

jobs:
  run:
    runs-on: ubuntu-latest

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

    steps:

    # ----------------------------------------
    # ① ソース取得
    # ----------------------------------------
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt


    # ----------------------------------------
    # ② 実行日取得（JST）
    # ----------------------------------------
    - name: Get Target Date (JST)
      run: |
        export TZ="Asia/Tokyo"
        TODAY=$(date +'%Y%m%d')
        echo "TODAY=$TODAY" >> $GITHUB_ENV
        echo "TARGET DATE = $TODAY"


    # ----------------------------------------
    # ③ スクレイピング
    # race_data_YYYYMMDD/ 以下にCSV生成
    # ----------------------------------------
    - name: Scrape Race Data
      run: |
        python race_info_collect.py ${TODAY}


    # ----------------------------------------
    # ④ AI用CSV整形（aiready.csv生成）
    # ----------------------------------------
    - name: Prepare AI Input
      run: |
        python prepare_ai_input.py ${TODAY}


    # ----------------------------------------
    # ⑤ AI解析（レースごとにループ）
    # aiready.csv → json ＋ prompt.txt
    # ----------------------------------------
    # ----------------------------------------
    # ⑤ AI解析（テスト用：1レースのみ）
    # ----------------------------------------
    - name: Run AI Predictions (3 races only, time order)
      run: |
        BASE_DIR="race_data_${TODAY}"

        # ai_ready.csv を時刻順で3レース取得
        RACES=$(ls ${BASE_DIR}/*_ai_ready.csv | sort | head -n 3)

        echo "AI解析対象レース:"
        echo "${RACES}"

        for CSV in ${RACES}; do
          echo "----- $(basename "$CSV") -----"
          python predict_race_ai.py "$CSV" gpt-3.5-turbo
        done



    #- name: Run AI Predictions (time order)
    #  run: |
    #    for csv in $(ls race_data_${TODAY}/*_aiready.csv | sort); do
    #      echo "AI解析（時刻順）: $csv"
    #      python predict_race_ai.py "$csv" gpt-4.0-mini
    #    done



    # ----------------------------------------
    # ⑥ Discord通知（レースごと）
    # json + aiready.csv をペアで送信
    # ----------------------------------------

    - name: Send Discord Notification (3 races only, time order)
      if: success()
      run: |
        BASE_DIR="race_data_${TODAY}"

        # ai_ready.csv を基準に3レース取得
        RACES=$(ls ${BASE_DIR}/*_ai_ready.csv | sort | head -n 3)

        echo "通知対象レース:"
        echo "${RACES}"

        for CSV in ${RACES}; do
          PREFIX="${CSV%_ai_ready.csv}"
          JSON="${PREFIX}.json"

          if [ -f "$JSON" ]; then
            echo "通知: $(basename "$JSON")"
            python notify_discord.py "$JSON" "$CSV"
          else
            echo "⚠ json が存在しないためスキップ: $JSON"
          fi
        done



    #- name: Send Discord Notifications (time order)
    #  if: success()
    #  run: |
    #    for json in $(ls race_data_${TODAY}/*.json | sort); do
    #      csv="${json%.json}_aiready.csv"
    #      if [ -f "$csv" ]; then
    #        echo "通知（時刻順）: $json"
    #        python notify_discord.py "$json" "$csv"
    #      fi
    #    done
